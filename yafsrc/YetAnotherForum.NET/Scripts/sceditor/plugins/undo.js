/* SCEditor v3.2.0 | (C) 2024, Sam Clarke | sceditor.com/license */
!function(){'use strict';sceditor.plugins.undo=function(){var n,i,a,o,r=this,s='',c=0,u=!1,d=!1,l=!1,e=50,t=[],g=0;function f(e){if(d=!0,i.sourceMode(e.sourceMode),e.sourceMode)i.val(e.value,!1),i.sourceEditorCaret(e.caret);else if(i.getBody().innerHTML=e.value,e.caret){var t=i.getRangeHelper().selectedRange(),n=t,e=e.caret;try{var o=e.startPositions,r=e.endPositions;n.setStart(m(a,o),o[0]),n.setEnd(m(a,r),r[0])}catch(e){console&&console.warn&&console.warn('[SCEditor] Undo plugin lost caret',e)}i.getRangeHelper().selectRange(t)}i.focus(),d=!1}function h(e,t){var n=e[t];e[t]=function(){var e=u;!e&&!d&&o&&i.getRangeHelper().hasSelection()&&v(),u=!0,n.apply(this,arguments),e||(u=!1,d)||(p(),s='')}}function p(){g&&(t.length-=g,g=0),0<e&&e<t.length&&t.shift(),o={},v(),t.push(o)}function v(){var e=i.sourceMode(),e=(o.caret=e?i.sourceEditorCaret():function(e){if(e)return a.normalize(),{startPositions:y(e.startContainer,e.startOffset),endPositions:y(e.endContainer,e.endOffset)}}(i.getRangeHelper().selectedRange()),(o.sourceMode=e)?i.getSourceEditorValue(!1):i.getBody().innerHTML),t=document.getElementById('editor-Counter'),n=i.opts.maxLength;i.val().length>n?r.undo():t.textContent=n-i.val().length,o.value=e}function E(){n===document.activeElement&&r.signalSelectionchangedEvent()}function y(e,t){for(var n=[t],o=e;o&&'BODY'!==o.tagName;)n.push(function(e){var t=0;for(;e=e.previousSibling;)t++;return t}(o)),o=o.parentNode;return n}function m(t,n){for(let e=n.length-1;t&&0<e;e--)t=t.childNodes[n[e]];return t}r.init=function(){e=(i=this).undoLimit||e,i.addShortcut('ctrl+z',r.undo),i.addShortcut('ctrl+shift+z',r.redo),i.addShortcut('ctrl+y',r.redo)},r.signalReady=function(){function e(e){'historyUndo'===e.inputType?(r.undo(),e.preventDefault()):'historyRedo'===e.inputType&&(r.redo(),e.preventDefault())}function t(){s='',p()}n=i.getContentAreaContainer().nextSibling,a=i.getBody(),p(),h(i,'setWysiwygEditorValue'),h(i,'setSourceEditorValue'),h(i,'sourceEditorInsertText'),h(i.getRangeHelper(),'insertNode'),h(i,'toggleSourceMode'),a.addEventListener('beforeinput',e),n.addEventListener('beforeinput',e),a.addEventListener('compositionend',t),n.addEventListener('compositionend',t),document.addEventListener('selectionchange',E)},r.destroy=function(){document.removeEventListener('selectionchange',E)},r.undo=function(){return o=null,g<t.length-1&&(g++,f(t[t.length-1-g])),!1},r.redo=function(){return 0<g&&(g--,f(t[t.length-1-g])),!1},r.signalSelectionchangedEvent=function(){d||l?l=!1:(o&&v(),s='')},r.signalInputEvent=function(e){var t=e.inputType;if(l=!0,t&&!e.isComposing)switch(e.inputType){case'deleteContentBackward':o&&s===t&&c<20?v():(p(),c=0),s=t;break;case'insertText':c+=e.data?e.data.length:1,o&&s===t&&c<20&&!/\s$/.test(e.data)?v():(p(),c=0),s=t;break;default:s='sce-misc',c=0,p()}}}}();