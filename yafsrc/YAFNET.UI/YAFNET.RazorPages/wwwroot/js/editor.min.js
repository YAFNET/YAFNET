var yafEditor=function(e,t,n,o,i,a,l){this.Name=e,this.UrlTitle=t,this.UrlDescription=n,this.UrlImageTitle=o,this.UrlImageDescription=i,this.Description=a,this.MediaTitle=l,document.querySelectorAll(".BBCodeEditor").forEach(e=>{new AutoCloseTags(e),new EditorUndoManager(e);e.addEventListener("keydown",function(e){!e.ctrlKey||e.altKey||66!=e.which&&73!=e.which&&85!=e.which&&81!=e.which&&13!=e.which||(66==e.which?wrapSelection(this,"[b]","[/b]"):73==e.which?wrapSelection(this,"[i]","[/i]"):85==e.which?wrapSelection(this,"[u]","[/u]"):81==e.which?wrapSelection(this,"[quote]","[/quote]"):13==e.which&&(null!=document.getElementById("QuickReplyDialog")?document.querySelector('[data-bs-save*="modal"]').click():null!=document.querySelector('[formaction*="PostReply"]')&&document.querySelector('[formaction*="PostReply"]').click()))})})},doc,I,StateMaker;function removeFormat(e){var t,n,o,i,a;e.setSelectionRange&&(t=e.selectionStart,i=(o=e.value.substring(t,n=e.selectionEnd)).replace(/\[.*?\]/g,""),a=o.length-i.length,e.value=e.value.replace(o,i),setSelectionRange(e,t,n-a))}function setSelectionRange(e,t,n){e.setSelectionRange?(e.focus(),e.setSelectionRange(t,n)):e.createTextRange&&((e=e.createTextRange()).collapse(!0),e.moveEnd("character",n),e.moveStart("character",t),e.select())}function setCaretToPos(e,t){setSelectionRange(e,t,t)}function replaceSelection(e,t){var n,o;e.setSelectionRange?(n=e.selectionStart,o=e.selectionEnd,e.value=e.value.substring(0,n)+t+e.value.substring(o),n!=o?setSelectionRange(e,n,n+t.length):setCaretToPos(e,n+t.length)):document.selection?(e.focus(),document.selection.createRange().text=t):(e.value+=t,e.focus())}function removeFromSelection(e,t,n){var o,i,a;e.setSelectionRange&&(o=e.selectionStart,-1!=(a=e.value.substring(o,i=e.selectionEnd)).indexOf(t))&&-1!=a.indexOf(n)&&(e.value=e.value.substring(0,o)+e.value.substring(o+t.length,i-n.length)+e.value.substring(i),o!=i?setSelectionRange(e,o,i-n.length-t.length):setCaretToPos(e,o+t.length))}function wrapSelection(e,t,n){var o,i;e.setSelectionRange?(o=e.selectionStart,i=e.selectionEnd,e.value=e.value.substring(0,o)+t+e.value.substring(o,i)+n+e.value.substring(i),o!=i?setSelectionRange(e,o,t.length+n.length+i):setCaretToPos(e,o+t.length)):document.selection&&(i=document.selection.createRange().text)?(document.selection.createRange().text=t+i+n,e.focus()):(e.value+=t,e.focus(),e.value+=n),e.dispatchEvent(new Event("change"))}function getCurrentSelection(e){var t;return e.setSelectionRange?e.selectionStart!=e.selectionEnd:!!document.selection&&(t=document.selection.createRange()).parentElement()==e&&""!=t.text}yafEditor.prototype.FormatText=function(e,t){var n=document.getElementById(this.Name);switch(e){case"bold":wrapSelection(n,"[b]","[/b]");break;case"italic":wrapSelection(n,"[i]","[/i]");break;case"underline":wrapSelection(n,"[u]","[/u]");break;case"strikethrough":wrapSelection(n,"[s]","[/s]");break;case"highlight":wrapSelection(n,"[h]","[/h]");break;case"code":wrapSelection(n,"[code]","[/code]");break;case"codelang":wrapSelection(n,`[code=${t}]`,"[/code]");break;case"media":getCurrentSelection(n)?wrapSelection(n,"[media]","[/media]"):bootbox.prompt({title:this.MediaTitle,placeholder:"https://",callback:function(e){replaceSelection(n,`[media]${e}[/media]`)}});break;case"img":getCurrentSelection(n)?wrapSelection(n,"[img]","[/img]"):bootbox.confirm({title:this.UrlImageTitle,message:`<form><div class="mb-3">
                                 <label for="url" class="form-label">${this.UrlImageTitle}</label> 
                                 <input type="text" class="form-control" id="url" placeholder="https://" />
                             </div>
                             <div class="mb-3">
                                 <label for="desc" class="form-label">${this.UrlImageDescription}</label>
                                 <input type="text" class="form-control" id="desc" placeholder="${this.Description}" />
                             </div></form>
                                 `,callback:function(e){var t;e&&(e=document.getElementById("url").value,t=document.getElementById("desc").value,replaceSelection(n,""!==t&&null!==t?`[img=${e}]${t}[/img]`:`[img]${e}[/img]`))}});break;case"quote":wrapSelection(n,"[quote]","[/quote]");break;case"justifyleft":wrapSelection(n,"[left]","[/left]");break;case"justifycenter":wrapSelection(n,"[center]","[/center]");break;case"justifyright":wrapSelection(n,"[right]","[/right]");break;case"indent":wrapSelection(n,"[indent]","[/indent]");break;case"outdent":getCurrentSelection(n)&&removeFromSelection(n,"[indent]","[/indent]");break;case"removeFormat":getCurrentSelection(n)&&removeFormat(n);break;case"createlink":bootbox.confirm({title:this.UrlTitle,message:`<form><div class="mb-3">
                                 <label for="url" class="form-label">${this.UrlTitle}</label> 
                                 <input type="text" class="form-control" id="url" placeholder="https://" />
                             </div>
                             <div class="mb-3">
                                 <label for="desc" class="form-label">${this.UrlDescription}</label>
                                 <input type="text" class="form-control" id="desc" placeholder="${this.Description}" />
                             </div></form>
                                 `,callback:function(e){var t;e&&(e=document.getElementById("url").value,t=document.getElementById("desc").value,replaceSelection(n,""!==t&&null!=t?`[url=${e}]${t}[/url]`:`[url]${e}[/url]`))}});break;case"unorderedlist":wrapSelection(n,"[list][*]","[/list]");break;case"orderedlist":wrapSelection(n,"[list=1][*]","[/list]");break;case"color":wrapSelection(n,`[color=${t}]`,"[/color]");break;case"font":wrapSelection(n,`[font=${t}]`,"[/font]");break;case"fontsize":wrapSelection(n,`[size=${t}]`,"[/size]");break;case"albumimg":replaceSelection(n,`[albumimg]${t}[/albumimg]`);break;case"attach":replaceSelection(n,`[attach]${t}[/attach]`);break;case"email":bootbox.confirm({title:this.UrlTitle,message:`<form><div class="mb-3">
                  <label for="url" class="form-label">${this.UrlTitle}</label> 
                  <input type="text" class="form-control" id="url" placeholder="https://" />
              </div>
              <div class="mb-3">
                  <label for="desc" class="form-label">${this.UrlDescription}</label>
                  <input type="text" class="form-control" id="desc" placeholder="${this.Description}" />
              </div></form>
                  `,callback:function(e){var t;e&&(e=document.getElementById("url").value,t=document.getElementById("desc").value,replaceSelection(n,""!==t&&null!=t?`[email=${e}]${t}[/email]`:`[email]${e}[/email]`))}});break;case"userlink":replaceSelection(n,`[userlink]${t}[/userlink]`);break;case"selectAll":n.select();break;case"cut":getCurrentSelection(n)&&document.execCommand("cut");break;case"copy":getCurrentSelection(n)&&document.execCommand("copy");break;case"paste":navigator.clipboard.readText().then(function(e){n.value+=e});break;default:wrapSelection(n,`[${e}]`,`[/${e}]`)}};var doc=document,I=function(e){return doc.getElementById(e)},StateMaker=function(e){e?(this.initialState=e,this.states=[e]):this.states=[],this.savedStates=[],this.canUndo=this.canRedo=!1,this.undoneStates=[],this.addState=function(e){return this.states.push(e),this.undoneStates=[],this.canUndo=!0,this.canRedo=!1,this},this.undo=function(){var e=this.states.length;return this.initialState?1<e&&(this.undoneStates.push(this.states.pop()),this.canRedo=!0,!(this.states.length<2))||(this.canUndo=!1):0<e?(this.undoneStates.push(this.states.pop()),this.canRedo=!0):this.canUndo=!1,this},this.redo=function(){return 0<this.undoneStates.length&&(this.states.push(this.undoneStates.pop()),this.canUndo=!0,!(this.undoneStates.length<1))||(this.canRedo=!1),this},this.save=function(){return this.savedStates=this.states.slice(),this},this.isSavedState=function(){return JSON.stringify(this.states)===JSON.stringify(this.savedStates)}},EditorUndoManager=function(e){var t,n=e,o=0,i=0,a=new StateMaker,l=I("undo"),s=I("redo"),r=n.parentElement.parentElement.querySelector("#editor-Counter"),c=n.maxLength;function u(e){t=e.value.trim(),(o=t.split(/\s+/).length)===i&&a.states.length?a.states[a.states.length-1]=t:(a.addState(t),i=o),e.value.length>c?e.value=e.value.substring(0,c):r.textContent=c-e.value.length}r.textContent=c-n.value.length,n.addEventListener("change",function(){u(this)}),n.onkeyup=function(){u(this)},l.onclick=function(){a.undo(),t=n.value=(a.states[a.states.length-1]||"").trim(),n.focus(),l.disabled=!a.canUndo,s.disabled=!a.canRedo},s.onclick=function(){a.redo(),t=n.value=(a.states[a.states.length-1]||"").trim(),n.focus(),l.disabled=!a.canUndo,s.disabled=!a.canRedo}},AutoCloseTags=function(e){this.textarea=e,this.autoClosingTags=["b","i","u","h","code","img","quote","left","center","right","indent","list","color","size","albumimg","attach","youtube","vimeo","instagram","twitter","facebook","googlewidget","spoiler","userlink","googlemaps","hide","group-hide","hide-thanks","hide-reply-thanks","hide-reply","hide-posts","dailymotion","audio","media"],this.enableAutoCloseTags()};function mentions(opts={}){opts=Object.assign({},{lookup:"lookup",id:"",selector:"",element:null,symbol:"@",items:[],item_template:'<a class="dropdown-item" href="#"><img src="${item.avatar}" alt="avatar" class="me-2 img-thumbnail" style="max-width:20px;max-height:20px" /> ${item.name}</a>',onclick:void 0,url:""},opts);let $e=opts.id&&document.getElementById(opts.id)||opts.selector&&document.querySelector(opts.selector)||opts.element;if(!$e)return console.error("Invalid element selector",opts);for(var $lookup=document.createElement("div"),range,start,end,prevWord,isFixed=($lookup.classList="fixed-top autohide "+opts.lookup,$e.parentNode.insertBefore($lookup,$e.nextSibling),$e.addEventListener("keydown",processKey),$e.addEventListener("keyup",showLookup),$e.addEventListener("click",hideLookup),!1),$el=$lookup.parentNode;$el&&"body"!==$el.nodeName.toLowerCase()&&!isFixed;)isFixed="fixed"===window.getComputedStyle($el).getPropertyValue("position").toLowerCase(),$el=$el.parentElement;function showLookup(event){if("Escape"===event.code)return hideLookup();var sel=window.getSelection(),$parent=$lookup.parentNode.querySelector("textarea"),text=sel.anchorNode.querySelector("textarea").value||"",curr=$parent.selectionStart,getLength=e=>e instanceof Array&&0<e.length?e[0].length:0,word=(start=curr-getLength(text.slice(0,curr).match(/[\S]+$/g)),end=curr+getLength(text.slice(curr).match(/^[\S]+/g)),text.substring(start,end));if(!word||word[0]!==opts.symbol)return prevWord="",hideLookup();if(word!==prevWord){prevWord=word;var pos={x:0,y:0},parentRect=$parent.getBoundingClientRect(),query=(pos.y=parentRect.top+30,pos.x=parentRect.left+20,$lookup.style.left=pos.x+"px",$lookup.style.top=pos.y+"px",word.slice(1)),items=(3<=query.length&&fetch(opts.url.replace("{q}",query),{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json;charset=utf-8",RequestVerificationToken:document.querySelector('input[name="__RequestVerificationToken"]').value}}).then(e=>e.json()).then(e=>opts.items=e),opts.items.filter(e=>e.name.toLowerCase().includes(word.slice(1).toLowerCase())).map(item=>eval('`<li class="mention-li-nt ${opts.lookup}" data-name = "${item.name}" data-id = "${item.id}">'+opts.item_template+"</li>`")));if(!items.length)return hideLookup();$lookup.innerHTML=`<ul class="dropdown-menu show">${items.join("")}</ul>`,[...$lookup.firstElementChild.children].forEach(e=>e.addEventListener("click",onClick)||e.addEventListener("mouseenter",onHover)),$lookup.firstElementChild.children[0].classList.add("active"),$lookup.hasAttribute("hidden")&&$lookup.removeAttribute("hidden");var bounding=$lookup.getBoundingClientRect();0<=bounding.top&&0<=bounding.left&&bounding.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&bounding.right<=(window.innerWidth||document.documentElement.clientWidth)||($lookup.style.top=parseInt($lookup.style.top)-10-$lookup.clientHeight+"px")}}function hideLookup(){$lookup.hasAttribute("hidden")||$lookup.setAttribute("hidden",!0)}function onClick(e){e=e.target.classList.contains("mention-li-nt")?e.target:e.target.parentElement,opts.onclick(e.dataset),e=$lookup.parentNode.querySelector("textarea");e.value=e.value.replace(e.value.substring(start+1,end),""),hideLookup()}function onHover(e){e=e.target.closest(".mention-li-nt");e.classList.contains("active")||([...$lookup.firstElementChild.children].filter(e=>e.classList.contains("active")).forEach(e=>e.classList.remove("active")),e.classList.add("active"))}function processKey(e){var t=e.key;if(-1!=["ArrowUp","ArrowDown","Enter"].indexOf(t)&&!$lookup.hasAttribute("hidden")){if(e.preventDefault(),"Enter"==t)return $lookup.querySelector(".active").click();var e=[...$lookup.firstElementChild.children],n=e.findIndex(e=>e.classList.contains("active")),n=(e[n].classList.remove("active"),e[(e.length+n+("ArrowUp"==t?-1:1))%e.length]);n.classList.add("active"),n.scrollIntoView(!1)}}}AutoCloseTags.prototype={enableAutoCloseTags:function(){var a=this;this.textarea.addEventListener("keydown",function(t){if("]"===t.key){var n,t=this.selectionStart,o=this.value.substr(0,t),i=this.value.substr(this.selectionEnd,this.value.length);let e;try{e=o.match(/\[([^\]]+)$/)[1].match(/^([a-z1-6]+)/)[1]}catch(e){return}-1!==a.autoClosingTags.indexOf(e)&&(n=`[/${e}]`,this.value=o+n+i,this.selectionStart=this.selectionEnd=t,this.focus())}})}};